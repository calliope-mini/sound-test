
#include "MicroBit.h"
#include "mbed.h"
#include "CalliopeMicrophone.h"
#include "CalliopeSoundTest.h"

#ifndef COMPILE_FIRMWARE_MASTER

MicroBit uBit;
CalliopeMicrophone cmic;

const uint8_t full[25] = {1, 1, 1, 1, 1,
                          1, 1, 1, 1, 1,
                          1, 1, 1, 1, 1,
                          1, 1, 1, 1, 1,
                          1, 1, 1, 1, 1
};

const MicroBitImage Full(5, 5, full);

uint8_t test_sample[0x400] = { 0x01,0x07,0x05,0x0B,0x08,0x10,0x0B,0x07,0x06,0x08,0x08,0x07,0x08,0x07,0x07,0x07,
                               0x05,0x06,0x04,0x08,0x07,0x07,0x0D,0x05,0x07,0x08,0x09,0x07,0x07,0x08,0x07,0x06,
                               0x04,0x06,0x05,0x06,0x11,0x06,0x07,0x08,0x07,0x07,0x09,0x07,0x06,0x07,0x05,0x06,
                               0x04,0x07,0x07,0x06,0x06,0x07,0x07,0x08,0x08,0x07,0x09,0x06,0x06,0x05,0x06,0x06,
                               0x06,0x06,0x10,0x06,0x05,0x0A,0x07,0x07,0x08,0x08,0x06,0x06,0x05,0x06,0x05,0x06,
                               0x09,0x02,0x07,0x07,0x06,0x09,0x07,0x07,0x08,0x08,0x05,0x07,0x05,0x06,0x05,0x05,
                               0x12,0x06,0x06,0x09,0x08,0x06,0x07,0x0A,0x05,0x06,0x06,0x06,0x04,0x06,0x10,0x06,
                               0x06,0x0A,0x06,0x07,0x07,0x09,0x06,0x07,0x04,0x06,0x05,0x07,0x0F,0x07,0x05,0x0A,
                               0x08,0x06,0x08,0x07,0x06,0x11,0x04,0x05,0x02,0x02,0x0F,0x06,0x08,0x07,0x09,0x05,
                               0x09,0x06,0x06,0x08,0x05,0x05,0x03,0x0A,0x0E,0x07,0x07,0x09,0x08,0x08,0x08,0x05,
                               0x06,0x07,0x05,0x0C,0x02,0x02,0x11,0x0A,0x04,0x0A,0x08,0x0A,0x05,0x09,0x02,0x07,
                               0x05,0x0E,0x02,0x02,0x0E,0x0C,0x02,0x0B,0x0A,0x0A,0x04,0x07,0x03,0x19,0x14,0x09,
                               0x01,0x0D,0x0E,0x09,0x04,0x02,0x03,0x0A,0x06,0x0D,0x10,0x08,0x02,0x0F,0x09,0x07,
                               0x09,0x14,0x04,0x09,0x10,0x1A,0x0C,0x09,0x03,0x02,0x02,0x08,0x03,0x0B,0x02,0x09,
                               0x0F,0x18,0x0D,0x08,0x02,0x0E,0x06,0x13,0x0F,0x15,0x13,0x2E,0x11,0x15,0x10,0x18,
                               0x02,0x15,0x0D,0x18,0x12,0x15,0x04,0x12,0x11,0x14,0x15,0x27,0x12,0x15,0x10,0x13,
                               0x07,0x13,0x0F,0x15,0x14,0x10,0x09,0x11,0x10,0x17,0x14,0x0B,0x0D,0x0D,0x10,0x17,
                               0x13,0x12,0x08,0x0B,0x0F,0x13,0x15,0x13,0x0E,0x07,0x0F,0x10,0x19,0x12,0x24,0x10,
                               0x18,0x16,0x21,0x11,0x14,0x19,0x21,0x12,0x16,0x17,0x22,0x15,0x17,0x13,0x98,0x18,
                               0x4B,0xFF,0xFF,0xFF,0xFF,0x24,0x69,0xF2,0xFF,0xFF,0x29,0xFF,0x2A,0x01,0xFF,0x0A,
                               0x02,0x74,0x38,0x08,0x02,0x02,0x42,0x64,0x03,0x0A,0x05,0x20,0x07,0x02,0x0A,0x05,
                               0x04,0x19,0x07,0x07,0x19,0x05,0x23,0x41,0x1C,0x3E,0x09,0x63,0x0F,0x60,0x10,0x27,
                               0x16,0x23,0x14,0x64,0x13,0x25,0x20,0x1F,0x11,0x13,0x02,0x06,0x07,0x03,0x13,0x06,
                               0x05,0x04,0x07,0x14,0x09,0x0F,0x05,0x05,0x04,0x06,0x07,0x20,0x04,0x06,0x05,0x03,
                               0x0B,0x0E,0x07,0x0D,0x0A,0x0B,0x0B,0x08,0x07,0x02,0x04,0x07,0x0B,0x08,0x0C,0x07,
                               0x0C,0x09,0x0B,0x07,0x0B,0x10,0x0B,0x08,0x0B,0x08,0x08,0x0B,0x07,0x0C,0x05,0x04,
                               0x04,0x06,0x07,0x02,0x0E,0x07,0x0C,0x07,0x07,0x0B,0x07,0x0D,0x04,0x06,0x03,0x07,
                               0x05,0x05,0x0B,0x07,0x0C,0x07,0x07,0x0B,0x06,0x06,0x03,0x06,0x06,0x02,0x04,0x06,
                               0x07,0x08,0x09,0x07,0x0C,0x07,0x07,0x0A,0x07,0x07,0x0B,0x0F,0x07,0x07,0x0A,0x07,
                               0x0C,0x06,0x07,0x0A,0x07,0x09,0x02,0x02,0x06,0x0E,0x07,0x09,0x09,0x08,0x09,0x09,
                               0x06,0x0A,0x08,0x07,0x04,0x02,0x06,0x08,0x05,0x06,0x03,0x07,0x0B,0x07,0x07,0x0B,
                               0x07,0x09,0x08,0x06,0x05,0x06,0x03,0x07,0x05,0x06,0x05,0x05,0x0B,0x07,0x06,0x0C,
                               0x06,0x0B,0x06,0x06,0x05,0x12,0x04,0x06,0x05,0x07,0x08,0x07,0x06,0x03,0x02,0x07,
                               0x06,0x0B,0x06,0x05,0x07,0x10,0x05,0x04,0x06,0x06,0x0A,0x07,0x0B,0x06,0x0A,0x07,
                               0x0B,0x0C,0x05,0x0E,0x05,0x05,0x0C,0x07,0x0B,0x06,0x0A,0x06,0x0B,0x0D,0x04,0x0F,
                               0x06,0x09,0x08,0x08,0x0A,0x08,0x08,0x09,0x07,0x0B,0x07,0x07,0x04,0x05,0x08,0x05,
                               0x0A,0x0A,0x08,0x08,0x09,0x09,0x08,0x07,0x01,0x02,0x07,0x10,0x15,0x0A,0x08,0x08,
                               0x0A,0x0A,0x07,0x0C,0x07,0x10,0x04,0x02,0x0D,0x0A,0x08,0x0A,0x0A,0x09,0x09,0x0B,
                               0x0A,0x0E,0x0F,0x0A,0x0A,0x0A,0x0B,0x09,0x09,0x0B,0x08,0x0A,0x14,0x0B,0x09,0x0B,
                               0x0B,0x0A,0x0B,0x0B,0x08,0x03,0x0A,0x02,0x0B,0x0C,0x0B,0x0B,0x0B,0x0D,0x07,0x13,
                               0x08,0x03,0x0C,0x0F,0x0B,0x0C,0x0E,0x13,0x03,0x0C,0x14,0x0F,0x0D,0x0E,0x0E,0x0F,
                               0x07,0x0A,0x02,0x02,0x02,0x02,0x0B,0x10,0x0E,0x0F,0x0D,0x0D,0x09,0x10,0x0B,0x0F,
                               0x10,0x11,0x0B,0x12,0x0E,0x03,0x0B,0x12,0x0F,0x10,0x0D,0x10,0x1C,0x02,0x02,0x0E,
                               0x11,0x10,0x0C,0x11,0x1E,0x0E,0x10,0x10,0x0D,0x11,0x1A,0x12,0x10,0x12,0x0D,0x0E,
                               0x1B,0x11,0x10,0x12,0x0B,0x11,0x18,0x15,0x0E,0x10,0x10,0x0F,0x1C,0x10,0x0F,0x12,
                               0x0D,0x12,0x15,0x15,0x10,0x0E,0x10,0x10,0x18,0x16,0x0E,0x0D,0x0D,0x14,0x18,0x16,
                               0x0F,0x0E,0x0B,0x15,0x1A,0x15,0x0F,0x28,0x1F,0x16,0x0D,0x0B,0x0D,0x0D,0x25,0x15,
                               0x0D,0x24,0x26,0xFF,0x04,0x09,0x11,0x09,0x14,0x0B,0x13,0x04,0x08,0x0E,0x06,0x10,
                               0x0A,0x0F,0x0B,0x0A,0x0A,0x1F,0x0F,0x0F,0x0A,0x10,0x08,0x07,0x0B,0x0C,0x0B,0x0A,
                               0x0C,0x0B,0x09,0x0E,0x14,0x0B,0x0A,0x0A,0x0B,0x09,0x0A,0x0F,0x08,0x05,0x04,0x06,
                               0x0A,0x0B,0x0A,0x0A,0x08,0x09,0x09,0x1D,0x16,0x0C,0x0A,0x07,0x0B,0x08,0x09,0x18,
                               0x03,0x04,0x06,0x0A,0x09,0x0C,0x0A,0x0C,0x09,0x0A,0x08,0x0D,0x19,0x05,0x13,0x0C,
                               0x0A,0x0C,0x0B,0x08,0x0D,0x0B,0x08,0x0D,0x23,0x0B,0x0B,0x06,0x1F,0x0F,0x05,0x0A,
                               0x08,0x07,0x12,0x0B,0x0A,0x08,0x0B,0x07,0x09,0x14,0x04,0x09,0x06,0x0B,0x0A,0x0C,
                               0x09,0x09,0x0B,0x08,0x06,0x13,0x05,0x0A,0x05,0x05,0x0D,0x0C,0x07,0x0A,0x08,0x0B,
                               0x07,0x09,0x04,0x06,0x04,0x0A,0x05,0x0A,0x08,0x0C,0x08,0x09,0x08,0x0A,0x07,0x07,
                               0x07,0x07,0x04,0x05,0x0B,0x06,0x09,0x08,0x0B,0x07,0x0B,0x09,0x09,0x06,0x07,0x07,
                               0x03,0x07,0x07,0x09,0x08,0x07,0x0B,0x07,0x0B,0x07,0x0C,0x07,0x07,0x06,0x04,0x07,
                               0x07,0x08,0x09,0x07,0x0B,0x06,0x0C,0x08,0x0B,0x0A,0x04,0x06,0x05,0x06,0x07,0x08,
                               0x08,0x07,0x0B,0x06,0x05,0x03,0x03,0x07,0x0E,0x07,0x04,0x08,0x05,0x05,0x07,0x08,
                               0x08,0x07,0x07,0x09,0x06,0x0D,0x0E,0x06,0x05,0x08,0x05,0x07,0x06,0x07,0x09,0x06,
                               0x08,0x08,0x0A,0x09,0x0D,0x0B,0x02,0x09,0x03,0x09,0x06,0x06,0x09,0x07,0x07,0x08,
                               0x0A,0x08,0x10,0x07,0x05,0x07,0x05,0x07,0x07,0x05,0x09,0x07,0x08,0x09,0x08,0x0A,
                               0x0A,0x07,0x0A,0x07,0x06,0x06,0x06,0x05,0x09,0x07,0x08,0x0A,0x08,0x09,0x09,0x0A
};


void play(MicroBitEvent event) {
    (void) event;
    uBit.serial.printf("playing sample \r\n");
    uBit.soundmotor.playSample(test_sample, 0x400);
   
    while (uBit.soundmotor.getMode() == 4) {};
    uBit.serial.printf("playback completed \r\n");
}

void record(MicroBitEvent event) {
    (void) event;
   
    uBit.display.clear();
    uBit.display.print(Full);
    
    cmic.recordSample(test_sample, 0x400);
    while (cmic.isRecording()) {};
    
    uBit.display.clear();
    for (int i = 0; i < 64; i++) {
        for (int j = 0; j < 16; j++) uBit.serial.printf(" %d", test_sample[(i << 4) + j]);
	uBit.serial.printf("\r\n");
    } 
}

int main() {
    // Initialise the micro:bit runtime.
    uBit.init();
    uBit.serial.baud(115200);
    uBit.display.clear();
    
    uBit.messageBus.listen(MICROBIT_ID_BUTTON_A, MICROBIT_BUTTON_EVT_CLICK, play);
    uBit.messageBus.listen(MICROBIT_ID_BUTTON_B, MICROBIT_BUTTON_EVT_CLICK, record);
    
    while(true) uBit.sleep(100);
}

#endif
